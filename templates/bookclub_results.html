<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>조 편성 결과</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
        --eva-purple: #6A0DAD; --eva-green: #00FF7F; --bg-dark: #1A1A1A;
        --card-dark: #2D2D2D; --text-light: #E5E5E5; --border-dark: #444444;
    }
    body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-dark); color: var(--text-light); }
    h1, h2, h3 { font-family: 'Orbitron', sans-serif; text-transform: uppercase; letter-spacing: 0.05em; }
    .eva-card { background-color: var(--card-dark); border: 1px solid var(--border-dark); }
    .eva-button { background-color: var(--eva-green); color: black; font-weight: bold; }
    .screenshot-view { background-color: var(--bg-dark); }
    .group-block { background-color: var(--card-dark); border: 1px solid var(--border-dark); }
  </style>
</head>
<body class="min-h-screen">

  <header class="bg-eva-purple text-white p-4 text-center">
    <h1 class="text-xl">조 편성 추천안</h1>
  </header>

  <div class="container mx-auto p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for suggestion in suggestions %}
      <div class="eva-card rounded-lg p-4 flex flex-col">
        <h2 class="text-lg text-eva-green mb-2">추천안 {{ loop.index }}</h2>
        <ul class="list-none mb-4 flex-1 space-y-1">
          {% for group in suggestion %}
            <li class="p-2 border-b border-border-dark text-sm">
              <strong>
                {% if group_names and group_names[loop.index0] %}{{ group_names[loop.index0] }}{% else %}그룹 {{ loop.index }}{% endif %}:
              </strong>
              {{ group|join(', ') }}
            </li>
          {% endfor %}
        </ul>
        <button onclick='previewSuggestion({{ suggestion|tojson }})' class="w-full eva-button py-2 rounded-md">
          스크린샷용 미리보기
        </button>
      </div>
    {% endfor %}
  </div>

  <div id="screenshot" class="screenshot-view hidden fixed inset-0 overflow-auto p-8 z-50">
    <div id="screenshot-groups"></div>
    <div class="actions fixed bottom-4 left-1/2 -translate-x-1/2 flex gap-4">
      <button class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-md" onclick="saveAndExit()">저장 후 종료</button>
      <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-md" onclick="cancelPreview()">다시 선택</button>
    </div>
  </div>

  <script>
    const present      = {{ present|tojson }};
    const facilitators = {{ facilitators|tojson }};
    const groupNames   = {{ group_names|tojson }};
    let selectedGroupsForSave = null;

    function previewSuggestion(groups) {
      selectedGroupsForSave = groups; // 저장할 그룹 정보 임시 저장
      document.body.classList.add('screen-mode');
      const cont = document.getElementById('screenshot-groups');
      cont.innerHTML = '';
      groups.forEach((grp, i) => {
        const d = document.createElement('div');
        d.className = 'group-block';
        d.textContent = (groupNames[i]||`그룹 ${i+1}`) + ': ' + grp.join(', ');
        cont.appendChild(d);
      });
      document.getElementById('screenshot').classList.add('active');
    }

    function saveAndExit() {
      if (!selectedGroupsForSave) {
          alert('저장할 그룹 정보가 없습니다.');
          return;
      }

      fetch('/api/bookclub/save',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          date: new Date().toISOString().split('T')[0],
          groups: selectedGroupsForSave,
          present,
          facilitators
        })
      }).then(r=>{
        if(r.ok) {
            alert('성공적으로 저장되었습니다!');
            // [수정] 저장 후 조 편성 페이지로 이동하도록 경로 변경
            window.location='/making_team'
        }
        else {
            alert('저장에 실패했습니다. 다시 시도해주세요.')
        }
      });
    }

    function cancelPreview() {
      selectedGroupsForSave = null; // 임시 저장 정보 초기화
      document.body.classList.remove('screen-mode');
      document.getElementById('screenshot').classList.remove('active');
    }
  </script>

</body>
</html>

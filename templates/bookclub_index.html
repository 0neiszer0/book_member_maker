<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ë…ì„œëª¨ì„ ì¡° í¸ì„±</title>
  <style>
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤ */
    :root { --primary: #4a90e2; --bg: #f7f9fc; --card: #ffffff; --text: #333; --border: #ddd; }
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 1rem; display: flex; flex-direction: column; align-items: center; }
    h1 { margin-bottom: 1rem; }
    form { width: 100%; max-width: 600px; }
    .section { background: var(--card); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem; overflow: hidden; }
    .section summary { list-style: none; background: var(--primary); color: #fff; padding: 0.75rem 1rem; cursor: pointer; font-weight: bold; }
    .section[open] summary { border-bottom: 1px solid var(--border); }
    .section div.content { padding: 1rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); gap: 0.5rem; }
    .form-check { display: flex; align-items: center; background: var(--bg); padding: 0.5rem; border-radius:4px; }
    .form-check input { margin-right: 0.5rem; }
    .controls { text-align: right; grid-column: 1 / -1; margin-bottom: 0.5rem; } /* controls div ì¶”ê°€ */
    .controls button { background: var(--primary); color: #fff; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; font-size: 0.85rem; margin-left: 0.5rem; cursor: pointer; }
    .controls button.secondary { background: #999; }
    .settings { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; padding: 1rem; }
    .settings label { display: flex; flex-direction: column; font-size: 0.9rem; margin-bottom: 0.5rem; }
    .settings input { margin-top: 0.3rem; padding: 0.4rem; border: 1px solid var(--border); border-radius: 4px; }
    .btn-submit { width: 100%; padding: 0.8rem; background: var(--primary); color: #fff; border: none; font-size: 1.1rem; border-radius: 6px; cursor: pointer; }
    .footer-nav { margin-top: 1.5rem; display: flex; justify-content: space-between; width: 100%; max-width: 600px; }
  </style>
</head>
<body>

  <h1>ğŸ“š ë…ì„œëª¨ì„ ì¡° í¸ì„±</h1>

  <!-- [ìˆ˜ì • 1] action ê²½ë¡œë¥¼ '/making_team'ìœ¼ë¡œ ë³€ê²½ -->
  <form method="POST" action="/making_team">

    <!-- ì°¸ì„ì ì„ íƒ -->
    <details class="section" open>
      <summary>ì˜¤ëŠ˜ ì˜¤ëŠ” ì‚¬ëŒ</summary>
      <div class="content">
        <div class="controls">
          <button type="button" id="select-all-present">ì „ì²´</button>
          <button type="button" class="secondary" id="deselect-all-present">í•´ì œ</button>
        </div>
        {% for m in members %}
          <label class="form-check">
            <input type="checkbox" name="present" value="{{ m.name }}">
            {{ m.name }}
          </label>
        {% endfor %}
      </div>
    </details>

    <!-- ë°œì œì ì„ íƒ -->
    <details class="section" open>
      <summary>ë°œì œì ì„ íƒ</summary>
      <div class="content">
        <div class="controls">
          <button type="button" id="select-all-facilitators">ì „ì²´</button>
          <button type="button" class="secondary" id="deselect-all-facilitators">í•´ì œ</button>
        </div>
        {% for m in members %}
          <label class="form-check">
            <input type="checkbox" name="facilitators" value="{{ m.name }}">
            {{ m.name }}
          </label>
        {% endfor %}
      </div>
    </details>

    <!-- ì¶”ê°€ ì„¤ì • -->
    <details class="section">
      <summary>âš™ï¸ ì¶”ê°€ ì„¤ì •</summary>
      <div class="settings">
        <label>ê·¸ë£¹ ìˆ˜ (ì„ íƒ)
          <input type="number" name="group_count" min="1" max="30" placeholder="ìë™">
        </label>
        <label>ê·¸ë£¹ ì´ë¦„ (ì‰¼í‘œë¡œ êµ¬ë¶„)
          <input type="text" name="group_names" placeholder="AíŒ€,BíŒ€,CíŒ€">
        </label>
      </div>
    </details>

    <button type="submit" class="btn-submit">ì¡° í¸ì„±í•˜ê¸°</button>
  </form>

  <div class="footer-nav">
      <!-- [ìˆ˜ì • 3] ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ëŠ” ë§í¬ -->
      <a href="/" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border-radius: 4px; text-decoration: none;">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>
      <button type="button" id="manage-history-btn" style="background: #17a2b8; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">ğŸ—‚ï¸ ì´ì „ ê¸°ë¡ ê´€ë¦¬</button>
  </div>


  <dialog id="history-dialog" style="width:90%;max-width:600px;padding:1rem; border:none;border-radius:8px;">
    <h3>ğŸ“œ ì´ì „ ëª¨ì„ ê¸°ë¡ ì¡°íšŒ/ì‚­ì œ</h3>
    <div id="history-list" style="min-height:100px;max-height:300px;overflow:auto; border:1px solid #ccc;border-radius:4px;padding:8px;">
      ë¡œë”© ì¤‘â€¦
    </div>
    <div style="text-align:right;margin-top:1rem;">
      <button type="button" id="history-close">ë‹«ê¸°</button>
    </div>
  </dialog>

  <script>
    // ì „ì²´ ì„ íƒ/í•´ì œ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
    document.getElementById('select-all-present').onclick = () => document.querySelectorAll('input[name="present"]').forEach(cb=>cb.checked=true);
    document.getElementById('deselect-all-present').onclick = () => document.querySelectorAll('input[name="present"]').forEach(cb=>cb.checked=false);
    document.getElementById('select-all-facilitators').onclick = () => document.querySelectorAll('input[name="facilitators"]').forEach(cb=>cb.checked=true);
    document.getElementById('deselect-all-facilitators').onclick = () => document.querySelectorAll('input[name="facilitators"]').forEach(cb=>cb.checked=false);
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const btnOpen  = document.getElementById('manage-history-btn');
      const dialog   = document.getElementById('history-dialog');
      const btnClose = document.getElementById('history-close');
      const listDiv  = document.getElementById('history-list');

      btnOpen.addEventListener('click', () => {
        listDiv.textContent = 'ë¡œë”© ì¤‘â€¦';
        dialog.showModal();

        // [ìˆ˜ì • 2] API ê²½ë¡œë¥¼ '/api/bookclub/history'ë¡œ ë³€ê²½
        fetch('/api/bookclub/history')
          .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
          .then(data => {
            listDiv.innerHTML = '';
            if (!data.length) {
              listDiv.textContent = 'ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
              return;
            }
            data.forEach((rec, idx) => {
              const row = document.createElement('div');
              row.style.cssText = 'display:flex;justify-content:space-between;padding:4px 0;align-items:center;';
              row.innerHTML = `
                <span><strong>${rec.date}</strong> â€” ${rec.groups.map(g=>g.join(', ')).join(' | ')}</span>
                <button data-idx="${idx}" style="background:#e74c3c;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">ì‚­ì œ</button>`;
              listDiv.appendChild(row);
            });

            listDiv.querySelectorAll('button').forEach(b => {
              b.onclick = () => {
                if (!confirm('ì •ë§ë¡œ ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                const i = +b.dataset.idx;

                // [ìˆ˜ì • 2] API ê²½ë¡œë¥¼ '/api/bookclub/history/delete'ë¡œ ë³€ê²½
                fetch('/api/bookclub/history/delete', {
                  method:'POST',
                  headers:{'Content-Type':'application/json'},
                  body: JSON.stringify({index: i})
                })
                .then(r => r.json())
                .then(j => {
                  if (j.status==='ok') btnOpen.click(); // ì„±ê³µ ì‹œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                  else alert('ì‚­ì œ ì‹¤íŒ¨');
                })
                .catch(e => alert('ì‚­ì œ ì˜¤ë¥˜: '+e));
              };
            });
          })
          .catch(e => { listDiv.textContent = 'ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'; console.error(e); });
      });

      btnClose.addEventListener('click', () => dialog.close());
    });
  </script>

</body>
</html>

